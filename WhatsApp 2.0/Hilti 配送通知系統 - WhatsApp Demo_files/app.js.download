// WhatsApp Demo Application with Smart Input Handling
class WhatsAppDemo {
    constructor() {
        this.messagesContainer = document.getElementById('messagesContainer');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.inputArea = document.getElementById('inputArea');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.restartBtn = document.getElementById('restartBtn');
        this.popupModal = document.getElementById('popupModal');
        this.modalClose = document.getElementById('modalClose');
        this.optionList = document.getElementById('optionList');
        
        this.currentFlow = null;
        this.waitingForInput = null;
        this.userInputData = {};
        
        this.initializeApp();
        this.bindEvents();
    }

    // Message data from the provided JSON
    messages = {
        "trigger1": {
            "id": "trigger1",
            "title": "Trigger 1: Can receive order?",
            "content": "ðŸš› Hilti é€è²¨é€šçŸ¥\næ‚¨å¥½ {orgin_name}ï¼\n\næ‚¨çš„è¨‚å–® #HK240821001 å·²å®‰æŽ’æ–¼ {orgin_date_week}é€è²¨ï¼š\n\nðŸ“‹ æ”¶è²¨äººï¼š{orgin_name}\nðŸ“ž é›»è©±ï¼š{orgin_phone}\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\nðŸ“… é…é€æ—¥æœŸï¼š{orgin_date_week}\nâ° é è¨ˆé…é€æ™‚é–“ï¼š08:30-12:00\nðŸ“¦ è²¨ç‰©æ¸…å–®ï¼ˆè«‹æª¢æŸ¥è²¨ç‰©åç¨±åŠæ•¸é‡ï¼‰ï¼šæŸ¥çœ‹è©³æƒ…\n\nè«‹ç¢ºèªä¸Šè¿°è³‡æ–™å’Œæ™‚é–“ï¼š\nâœ… è¨‚å–®è³‡æ–™åŠæ™‚é–“ç„¡èª¤\nè«‹é»žæ“Šã€Œç¢ºèªè¨‚å–®è³‡æ–™åŠæ™‚é–“ç„¡èª¤ã€\n\nâŒå¦‚é©åˆä»¥ä¸‹æƒ…æ³ï¼š\nðŸ“… æ”¹æœŸé…é€\nðŸ“ž è²¨ç‰©æ¸…å–®æœ‰å•é¡Œï¼ˆæ³¨æ„ï¼šé¸æ“‡æ­¤é …å°‡æš«åœé…é€ï¼‰\nðŸ‘¤ æ›´æ”¹æ”¶è²¨äºº\nè«‹é»žæ“Šã€Œè¨‚å–®è³‡æ–™åŠæ™‚é–“æœ‰èª¤ã€\n\nâš ï¸ è‹¥æœªæ”¶åˆ°æ‚¨çš„å›žè¦†ï¼Œæˆ‘å€‘æœƒè‡ªå‹•å®‰æŽ’åŽŸå®šæ™‚é–“é€è²¨ã€‚\n\nðŸ“± è¨‚å–®è¿½è¹¤è«‹æŸ¥çœ‹ï¼š\nHilti Online â†’ æˆ‘çš„è¨‚å–® â†’ è¨‚å–®è¿½è¹¤\nç¶²å€ï¼šhilti.com.hk/myorders\n\nðŸ’¬ éœ€è¦å…¶ä»–å”åŠ©ï¼ŸWhatsAppå®¢æœ Haileyï¼šé»žæ“Šè¯çµ¡\n\nðŸ¤– æœ¬è¨Šæ¯ç”±ç³»çµ±è‡ªå‹•ç™¼é€ï¼Œç„¡æ³•å›žè¦†å°è©±",
            "buttons": [
                {
                    "text": "âœ… è¨‚å–®è³‡æ–™åŠæ™‚é–“ç„¡èª¤",
                    "action": "trigger2"
                },
                {
                    "text": "âŒ è¨‚å–®è³‡æ–™åŠæ™‚é–“æœ‰èª¤",
                    "action": "show_popup",
                    "listItems": [
                        {
                            "emoji": "ðŸ“…",
                            "title": "éœ€è¦æ”¹æœŸé…é€",
                            "description": "é‡æ–°å®‰æŽ’é…é€æ—¥æœŸ",
                            "action": "trigger3"
                        },
                        {
                            "emoji": "ðŸ“ž",
                            "title": "è²¨ç‰©æ¸…å–®æœ‰å•é¡Œ",
                            "description": "æ³¨æ„ï¼šé¸æ“‡æ­¤é …å°‡æš«åœé…é€",
                            "action": "trigger4"
                        },
                        {
                            "emoji": "ðŸ‘¤",
                            "title": "æ›´æ”¹æ”¶è²¨äºº",
                            "description": "ä¿®æ”¹æ”¶è²¨äººå§“åæˆ–é›»è©±",
                            "action": "trigger5"
                        }
                    ]
                }
            ]
        },
        "trigger2": {
            "id": "trigger2",
            "title": "Trigger 2: Confirmation - delivery scheduled",
            "content": "ðŸ“… Hilti é…é€ç¢ºèªé€šçŸ¥\næ‚¨å¥½ {confirmed_name}ï¼\n\næ„Ÿè¬æ‚¨ç¢ºèªæ˜¯æ¬¡çš„é…é€å®‰æŽ’ã€‚\n\nðŸ“¦ è¨‚å–® #HK240821001\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\nðŸ“ž é›»è©±ï¼š{confirmed_phone}\nðŸ“… é…é€æ—¥æœŸï¼š(confirmed delivery dataï¼‰\nâ° é è¨ˆé…é€æ™‚é–“ï¼š08:30-12:00\nðŸ“¦ è²¨ç‰©æ¸…å–®ï¼šæŸ¥çœ‹è©³æƒ…\n\nðŸ“‹ é…é€é ˆçŸ¥ï¼š\nâ€¢ å¸æ©Ÿå°‡æ–¼é€è²¨å‰æœ€å°‘15åˆ†é˜è‡´é›»ç¢ºèª\nâ€¢ è«‹ç¢ºä¿æŒ‡å®šæ”¶è²¨äººå“¡åœ¨ç¾å ´\nâ€¢ è«‹é ç•™å……è¶³æ™‚é–“å®Œæˆäº¤æ”¶\nâ€¢ å¦‚éœ€ç°½æ”¶ï¼Œè«‹æº–å‚™ç›¸é—œå°ç« æˆ–ç°½å\nâ€¢ å¦‚ç‚ºè²¨åˆ°ä»˜æ¬¾ï¼ˆCODï¼‰ï¼Œè«‹æº–å‚™è¶³å¤ ç¾é‡‘",
            "buttons": [
                {
                    "text": "ï¼ˆDriver triggerï¼‰ ç¹¼çºŒåˆ°é…é€æ—¥",
                    "action": "trigger6"
                }
            ]
        },
        "trigger3": {
            "id": "trigger3",
            "title": "æ”¹æœŸé…é€",
            "content": "ðŸ“… Hilti æ”¹æœŸé…é€\næ‚¨å¥½ é™³å…ˆç”Ÿï¼\n\näº†è§£æ‚¨æœªèƒ½æŽ¥æ”¶ä¸Šè¿°çš„é…é€æ™‚é–“ï¼Œæˆ‘å€‘å·²ç‚ºæ‚¨é‡æ–°å®‰æŽ’ã€‚\n\nðŸ“¦ è¨‚å–® #HK240821001\nðŸ“‹ æ”¶è²¨äººï¼šé™³å…ˆç”Ÿ\nðŸ“ž é›»è©±ï¼š61231234\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\n\nâš ï¸ å¦‚ä»¥ä¸Šæ—¥æœŸéƒ½ç„¡æ³•é…åˆï¼Œè«‹è¯çµ¡å®¢æœå®‰æŽ’å…¶ä»–æ™‚é–“\nâš ï¸ è‹¥æœªæ”¶åˆ°æ‚¨çš„å›žè¦†ï¼Œæˆ‘å€‘æŒ‰åŽŸå®šæ™‚é–“é€è²¨",
            "buttons": [
                {
                    "text": "ðŸ“… é¸æ“‡æ–°æ™‚é–“",
                    "action": "show_popup",
                    "listItems": [
                        {
                            "emoji": "ðŸ—“ï¸",
                            "title": "2025/8/23ï¼ˆæ˜ŸæœŸå…­ï¼‰",
                            "description": "ï¼ˆTBC, Maybe time range, like belowsï¼‰",
                            "action": "trigger2"
                        },
                        {
                            "emoji": "ðŸ—“ï¸",
                            "title": "2025/8/26ï¼ˆæ˜ŸæœŸä¸€ï¼‰",
                            "description": "08:30-12:00",
                            "action": "trigger2"
                        },
                        {
                            "emoji": "ðŸ—“ï¸",
                            "title": "2025/8/27ï¼ˆæ˜ŸæœŸäºŒï¼‰",
                            "description": "08:30-12:00",
                            "action": "trigger2"
                        },
                        {
                            "emoji": "ðŸ—“ï¸",
                            "title": "2025/8/28ï¼ˆæ˜ŸæœŸä¸‰ï¼‰",
                            "description": "08:30-12:00",
                            "action": "trigger2"
                        }
                    ]
                },
                {
                    "text": "ðŸ“ž è¯çµ¡å®¢æœ",
                    "action": "trigger4"
                },
                {
                    "text": "ðŸ”™ è¿”å›žä¸»ç›®éŒ„",
                    "action": "trigger1"
                }
            ]
        },
        "trigger4": {
            "id": "trigger4",
            "title": "Hilti CS contact options",
            "content": "ðŸ›Žï¸ Hilti å®¢æˆ¶æœå‹™é¸æ“‡ç¢ºèª\n\nâš ï¸ é‡è¦æé†’ï¼š\næ‚¨å·²é¸æ“‡ã€Œè¯çµ¡å®¢æœã€ã€‚è«‹ç¢ºèªï¼Œå¦‚é¸æ“‡æ­¤æœå‹™ï¼Œæ‚¨çš„è¨‚å–®å°‡æš«æ™‚æš«åœé…é€ï¼Œç­‰å¾…æˆ‘å€‘å®¢æœåœ˜éšŠå”åŠ©è™•ç†å¾Œæ‰æœƒå†å®‰æŽ’æ´¾é€ã€‚\n\nè‹¥æœªæ”¶åˆ°æ‚¨çš„å›žè¦†ï¼Œæˆ‘å€‘æœƒè‡ªå‹•å®‰æŽ’åŽŸå®šæ™‚é–“é€è²¨ã€‚",
            "buttons": [
                {
                    "text": "ðŸ’¬ WhatsAppå®¢æœ",
                    "action": "trigger4_2"
                },
                {
                    "text": "ðŸ”™ è¿”å›žä¸»ç›®éŒ„",
                    "action": "trigger1"
                }
            ]
        },
        "trigger4_2": {
            "id": "trigger4_2", 
            "title": "Hilti WhatsAppå®¢æœ",
            "content": "ðŸ’¬ Hilti WhatsAppå®¢æœ\n\nå¦‚æœªèƒ½ç¢ºèªä¸Šè¿°çš„é…é€å®‰æŽ’ï¼Œæˆ–è¨‚å–®è³‡æ–™æœ‰å•é¡Œï¼Œè«‹é»žæ“Šä»¥ä¸‹é€£çµè¯çµ¡æˆ‘å€‘ï¼š\nï¼ˆé»žæ“Šé€£çµå°‡è½‰è‡³Hilti WhatsAppå®¢æœï¼‰",
            "buttons": [
                {
                    "text": "ðŸ’¬ è¯çµ¡ Hailey",
                    "action": "end_cs"
                }
            ]
        },
        "trigger5": {
            "id": "trigger5",
            "title": "æ›´æ–°æ”¶è²¨äººè³‡è¨Š",
            "content": "ðŸ–Šï¸ æ›´æ–°æ”¶è²¨äººè³‡è¨Š\n\nè«‹æ–¼ã€deadlineã€‘å‰å®Œæˆä»¥ä¸‹è³‡æ–™æ›´æ–°ï¼š\n\nè«‹è¼¸å…¥æ–°çš„æ”¶è²¨äººå§“åï¼š",
            "inputType": "name",
            "buttons": []
        },
        "name_input_received": {
            "id": "name_input_received",
            "title": "æ”¶åˆ°å§“å",
            "content": "âœ… å·²æ”¶åˆ°æ”¶è²¨äººå§“åã€‚\nè«‹è¼¸å…¥æ–°çš„è¯çµ¡é›»è©±ï¼š",
            "inputType": "phone",
            "buttons": []
        },
        "phone_input_received": {
            "id": "phone_input_received",
            "title": "è³‡æ–™ç¢ºèª",
            "content": "âœ… å·²æ”¶åˆ°æ–°çš„æ”¶è²¨äººè³‡æ–™ï¼š\nðŸ‘¤ å§“åï¼š{user_name}\nðŸ“ž é›»è©±ï¼š{user_phone}\n\nè«‹ç¢ºèªæ˜¯å¦æ­£ç¢ºï¼Ÿ",
            "buttons": [
                {
                    "text": "âœ… ç¢ºèª",
                    "action": "trigger2"
                },
                {
                    "text": "âœï¸ é‡æ–°è¼¸å…¥",
                    "action": "trigger5"
                }
            ]
        },
        "trigger6": {
            "id": "trigger6",
            "title": "é…é€è¿½è¹¤",
            "content": "ðŸ“ Hilti é…é€è¿½è¹¤\né™³å…ˆç”Ÿï¼Œæ‚¨çš„è¨‚å–®ä»Šæ—¥é€é”ï¼\n\nðŸ“¦ è¨‚å–® #HK240821001 é…é€å®‰æŽ’ï¼š\nðŸ“‹ æ”¶è²¨äººï¼š{confrimed_name}\nðŸ“ž é›»è©±ï¼š{confirmed_phone}\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\nðŸšš é€è²¨æ™‚æ®µï¼š08:30-12:00\nðŸš› å¸æ©Ÿï¼šæŽå¸«å‚… (9123-4567)\n\nðŸ“‹ é…é€é ˆçŸ¥ï¼š\nâ€¢ å¸æ©Ÿå°‡æ–¼é€è²¨å‰æœ€å°‘15åˆ†é˜è‡´é›»ç¢ºèª\nâ€¢ è«‹ç¢ºä¿æŒ‡å®šæ”¶è²¨äººå“¡åœ¨ç¾å ´\nâ€¢ è«‹é ç•™å……è¶³æ™‚é–“å®Œæˆäº¤æ”¶\n\nðŸ“± è¨‚å–®è¿½è¹¤ï¼šhilti.com.hk/myorders",
            "buttons": [
                {
                    "text": "(Logflow trigger)ç¹¼çºŒåˆ°åœ¨é€”é€šçŸ¥",
                    "action": "trigger7"
                }
            ]
        },
        "trigger7": {
            "id": "trigger7",
            "title": "åœ¨é€”é€šçŸ¥",
            "content": "ðŸš› å¸æ©Ÿæ­£åœ¨å‰å¾€é€è²¨åœ°å€\n\né™³å…ˆç”Ÿï¼Œå¸æ©Ÿç¾æ­£å‡ºç™¼ï¼\n\nå¸æ©Ÿå°‡æ–¼åˆ°é”å‰æœ€å°‘15åˆ†é˜è‡´é›»è¯çµ¡ã€‚",
            "buttons": [
                {
                    "text": "(Driver trigger) é…é€æˆåŠŸ",
                    "action": "trigger9"
                },
                {
                    "text": "(Driver trigger)é…é€å¤±æ•—",
                    "action": "trigger8"
                },
                {
                    "text": "(Driver trigger) å®¢äººè¦æ±‚æ”¹æœŸ",
                    "action": "reschedule_confirm"
                }
            ]
        },
        "reschedule_confirm": {
            "id": "reschedule_confirm",
            "title": "æ”¹æœŸç¢ºèª",
            "content": "ðŸ“… æ”¶åˆ°æ”¹æœŸè¦æ±‚\n\næˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„æ”¹æœŸè¦æ±‚ã€‚å¸æ©Ÿå°‡å”åŠ©æ‚¨é‡æ–°å®‰æŽ’é…é€æ™‚é–“ã€‚\n\næ­£åœ¨ç‚ºæ‚¨å®‰æŽ’æ–°çš„é…é€æ—¥æœŸ...",
            "buttons": [
                {
                    "text": "ðŸ“… ç¢ºèªæ–°é…é€å®‰æŽ’",
                    "action": "trigger2"
                }
            ]
        },
        "trigger8": {
            "id": "trigger8",
            "title": "é…é€å¤±æ•—",
            "content": "ðŸ“¦ Hilti é…é€æœªèƒ½å®Œæˆé€šçŸ¥\næ‚¨å¥½ é™³å…ˆç”Ÿï¼\næˆ‘å€‘å˜—è©¦æ–¼{confirmed_delivery_date}é€é”æ‚¨çš„è¨‚å–®ï¼Œä½†æ‚¨æš«æ™‚ç„¡æ³•æŽ¥æ”¶ï¼Œè²¨ç‰©å°‡æœƒé€€å›žå€‰åº«ã€‚\n\nðŸ“¦ è¨‚å–® #HK240821001\nðŸ“‹ æ”¶è²¨äººï¼šé™³å…ˆç”Ÿ\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\nðŸ“… åŽŸå®šé…é€æ—¥æœŸï¼š{origin_delivery_date}\n\nðŸ”„ ä¸‹ä¸€æ­¥å®‰æŽ’ï¼š\nè²¨ç‰©å·²é€€å›žå€‰åº«ï¼Œè«‹æ‚¨è¯çµ¡å®¢æœé‡æ–°å®‰æŽ’é…é€æ™‚é–“\n\nðŸ’¬ WhatsApp å®¢æœ Haileyï¼šé»žæ“Šè¯çµ¡\n\næ„Ÿè¬æ‚¨çš„é…åˆï¼ŒæœŸå¾…ç›¡å¿«ç‚ºæ‚¨å®‰æŽ’æ–°çš„é€è²¨æ™‚é–“ï¼",
            "buttons": [
                {
                    "text": "ðŸ”„ é‡æ–°é–‹å§‹",
                    "action": "trigger1"
                }
            ]
        },
        "trigger9": {
            "id": "trigger9",
            "title": "é…é€å®Œæˆ",
            "content": "âœ… Hilti é…é€å®Œæˆç¢ºèª\næ‚¨å¥½ é™³å…ˆç”Ÿï¼\næ‚¨çš„è¨‚å–®å·²æˆåŠŸé…é€å®Œæˆï¼\n\nðŸ“¦ è¨‚å–® #HK240821001\nðŸ“‹ æ”¶è²¨äººï¼š{confrimed_name}\nðŸ“ åœ°å€ï¼šé¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­1è™Ÿ\nðŸ“… é…é€æ—¥æœŸï¼š{confirmed_delivery_date}\n\nðŸ“± å”®å¾Œæœå‹™ï¼š\nå¦‚å°ç”¢å“æœ‰ä»»ä½•ç–‘å•æˆ–éœ€è¦æŠ€è¡“æ”¯æ´ï¼Œè«‹è¯çµ¡æˆ‘å€‘ï¼š\nðŸ’¬ WhatsApp å®¢æœ Haileyï¼šé»žæ“Šè¯çµ¡\n\nðŸ™ æ„Ÿè¬é¸æ“‡ Hiltiï¼\nå¦‚æ‚¨æ»¿æ„æˆ‘å€‘çš„æœå‹™ï¼Œæ­¡è¿Žç¹¼çºŒé¸ç”¨ Hilti å„ªè³ªç”¢å“ã€‚",
            "buttons": [
                {
                    "text": "ðŸ”„ é‡æ–°é–‹å§‹",
                    "action": "trigger1"
                }
            ]
        },
        "end_cs": {
            "id": "end_cs",
            "title": "è½‰æŽ¥å®¢æœ",
            "content": "ðŸ”„ æ­£åœ¨ç‚ºæ‚¨è½‰æŽ¥åˆ° WhatsApp å®¢æœ Hailey...\nè«‹ç¨å€™ï¼Œå®¢æœäººå“¡å°‡æœƒå”åŠ©æ‚¨è™•ç†è¨‚å–®ç›¸é—œå•é¡Œã€‚\n\næ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å€™ï¼",
            "buttons": [
                {
                    "text": "ðŸ”„ é‡æ–°é–‹å§‹",
                    "action": "trigger1"
                }
            ]
        },
        "invalid_input": {
            "id": "invalid_input",
            "title": "ç„¡æ³•è­˜åˆ¥å›žè¦†",
            "content": "âš ï¸ ç„¡æ³•è­˜åˆ¥æ‚¨çš„å›žè¦†\nè«‹é¸æ“‡ä¸Šè¿°é¸é …ä¾†ç¢ºèªï¼š\n\nðŸ’¬ éœ€è¦å…¶ä»–å”åŠ©ï¼ŸWhatsAppå®¢æœ Haileyï¼šé»žæ“Šè¯çµ¡",
            "buttons": []
        }
    };

    initializeApp() {
        // Input area is always visible and ready
        this.showInputArea();
        this.startChatFlow();
    }

    bindEvents() {
        // Restart button
        this.restartBtn.addEventListener('click', () => {
            this.restartChat();
        });

        // Modal events
        this.modalClose.addEventListener('click', () => {
            this.hidePopup();
        });

        this.popupModal.querySelector('.modal-overlay').addEventListener('click', () => {
            this.hidePopup();
        });

        // Input events - always enabled
        this.sendBtn.addEventListener('click', () => {
            this.handleSendMessage();
        });

        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendMessage();
            }
        });
    }

    startChatFlow() {
        setTimeout(() => {
            this.showMessage('trigger1');
        }, 1000);
    }

    restartChat() {
        this.messagesContainer.innerHTML = '';
        this.hidePopup();
        this.currentFlow = null;
        this.waitingForInput = null;
        this.userInputData = {};
        this.messageInput.value = '';
        this.startChatFlow();
    }

    showTypingIndicator() {
        this.typingIndicator.classList.remove('hidden');
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        this.typingIndicator.classList.add('hidden');
    }

    async showMessage(messageId, userResponse = null) {
        // Show user message if provided
        if (userResponse) {
            this.addUserMessage(userResponse);
            await this.delay(500);
        }

        this.showTypingIndicator();
        await this.delay(1500);
        this.hideTypingIndicator();

        const message = this.messages[messageId];
        if (!message) {
            console.error('Message not found:', messageId);
            return;
        }

        let content = message.content;
        
        // Replace placeholders with user data
        if (this.userInputData.name) {
            content = content.replace('{user_name}', this.userInputData.name);
        }
        if (this.userInputData.phone) {
            content = content.replace('{user_phone}', this.userInputData.phone);
        }

        this.addSystemMessage(content, message.buttons);
        this.currentFlow = messageId;

        // Handle input requirements
        if (message.inputType) {
            this.waitingForInput = message.inputType;
        } else {
            this.waitingForInput = null;
        }
    }

    addSystemMessage(content, buttons = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message--received';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.innerHTML = '<div class="avatar-icon">H</div>';

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        bubbleDiv.textContent = content;

        // Add buttons if provided
        if (buttons && buttons.length > 0) {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'message-buttons';

            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = 'message-btn';
                btn.textContent = button.text;
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Button clicked:', button.text, 'Action:', button.action);
                    this.handleButtonClick(button);
                });
                buttonsDiv.appendChild(btn);
            });

            bubbleDiv.appendChild(buttonsDiv);
        }

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(bubbleDiv);
        this.messagesContainer.appendChild(messageDiv);
        
        this.scrollToBottom();
    }

    addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message--sent';

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        bubbleDiv.textContent = text;

        messageDiv.appendChild(bubbleDiv);
        this.messagesContainer.appendChild(messageDiv);
        
        this.scrollToBottom();
    }

    handleButtonClick(button) {
        console.log('Handling button click:', button);
        
        if (button.action === 'show_popup') {
            this.showPopup(button.listItems);
        } else {
            // Show the message immediately
            setTimeout(() => {
                this.showMessage(button.action, button.text);
            }, 100);
        }
    }

    showPopup(listItems) {
        this.optionList.innerHTML = '';

        listItems.forEach(item => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <div class="option-emoji">${item.emoji}</div>
                <div class="option-content">
                    <div class="option-title">${item.title}</div>
                    <div class="option-description">${item.description}</div>
                </div>
            `;
            
            optionDiv.addEventListener('click', () => {
                console.log('Option selected:', item.title, 'Action:', item.action);
                this.hidePopup();
                setTimeout(() => {
                    this.showMessage(item.action, item.title);
                }, 100);
            });

            this.optionList.appendChild(optionDiv);
        });

        this.popupModal.classList.remove('hidden');
    }

    hidePopup() {
        this.popupModal.classList.add('hidden');
    }

    showInputArea() {
        // Input area is always visible, just ensure it's focused when needed
        if (this.waitingForInput) {
            setTimeout(() => {
                this.messageInput.focus();
            }, 100);
        }
    }

    // Smart input handling logic
    handleSendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;

        // Clear input immediately
        this.messageInput.value = '';

        console.log('Processing input:', message, 'Waiting for:', this.waitingForInput, 'Current flow:', this.currentFlow);

        // Smart logic: Check if we're in a special input flow
        if (this.waitingForInput === 'name') {
            // We're expecting name input in the recipient update flow
            this.userInputData.name = message;
            this.showMessage('name_input_received', message);
        } else if (this.waitingForInput === 'phone') {
            // We're expecting phone input in the recipient update flow
            this.userInputData.phone = message;
            this.showMessage('phone_input_received', message);
        } else {
            // Not in a special input flow - show standard error response
            console.log('Showing invalid input response for:', message);
            this.showMessage('invalid_input', message);
        }
    }

    scrollToBottom() {
        setTimeout(() => {
            // Scroll the messages container
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            // Also scroll the chat container
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }, 100);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing WhatsApp Demo');
    new WhatsAppDemo();
});